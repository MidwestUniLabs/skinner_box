{% extends "base.html" %}

{% block head %}
    <title>Skinnerbox - Log Viewer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
{% endblock %}

{% block scripts %}
    <script>
        onload = function () {
            fetch('/current_user')
                .then(response => response.json())
                .then(data => {
                    if (!data.current_user) {
                        document.getElementById('remote-logs').style.display = 'none';
                        document.getElementById('remote-log-btn').style.display = 'none';
                        document.getElementById('local-log-btn').style.display = 'inline-block';
                        showLocalLogs();
                    } else {
                        document.getElementById('remote-logs').style.display = 'block';
                        document.getElementById('remote-log-btn').style.display = 'inline-block';
                        document.getElementById('local-log-btn').style.display = 'inline-block';
                        document.getElementById('LoginWarning').style.display = 'none';
                        showRemoteLogs();
                    }
                })
                .catch(error => console.error('Error fetching current user:', error));
        };

        function viewRemoteLog(trialInfo) {
            console.log("Viewing trial details:", trialInfo);

            const logViewer = document.getElementById('log-viewer');

            // Clear existing content
            logViewer.innerHTML = '';

            // Add trial summary details
            const trialSummary = `
                <table>
                    <tr><th>Date/Time</th><th>Total Time</th><th>Total Interactions</th></tr>
                    <tr>
                        <td>${new Date(trialInfo.start_time).toLocaleString()}</td>
                        <td>${((new Date(trialInfo.end_time) - new Date(trialInfo.start_time)) / 1000).toFixed(2)}</td>
                        <td>${trialInfo.total_interactions}</td>
                    </tr>
                </table>
            `;
            logViewer.innerHTML += trialSummary;

            // Add trial entry details
            if (trialInfo.valuesInfoPosition && trialInfo.valuesInfoPosition.length > 0) {
                const trialValuesTable = `
                    <table>
                        <tr>
                            <th>Entry</th><th>Interaction Time</th><th>Type</th>
                            <th>Reward</th><th>Interactions Between</th><th>Time Between</th>
                        </tr>
                        ${trialInfo.valuesInfoPosition.map(entry => `
                            <tr>
                                <td>${entry.entry_num}</td>
                                <td>${entry.rel_time}</td>
                                <td>${entry.type}</td>
                                <td>${entry.reward ? 'Yes' : 'No'}</td>
                                <td>${entry.interactions_between}</td>
                                <td>${entry.time_between}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
                logViewer.innerHTML += trialValuesTable;
            } else {
                logViewer.innerHTML += '<p>No trial entries available.</p>';
            }
        }

        function viewLocalLog(filename) {
            console.log(`Fetching local log content for: ${filename}`);

            const rawDownloadBtn = document.getElementById('download-btn');
            const excelDownloadBtn = document.getElementById('download-excel-btn');

            // Ensure correct file paths
            rawDownloadBtn.setAttribute("data-filename", filename);
            excelDownloadBtn.setAttribute("data-filename", filename);

            rawDownloadBtn.style.display = 'inline-block';
            excelDownloadBtn.style.display = 'inline-block';
            document.getElementById('push-cloud-btn').style.display = 'inline-block';

            fetch(`/view-log/${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(trialInfo => {
                    console.log("Viewing local trial details:", trialInfo);
                    const logViewer = document.getElementById('log-viewer');
                    logViewer.innerHTML = '';

                    // Add trial summary details
                    const trialSummary = `
                        <table>
                            <tr><th>Date/Time</th><th>Total Time</th><th>Total Interactions</th></tr>
                            <tr>
                                <td>${new Date(trialInfo.start_time).toLocaleString()}</td>
                                <td>${((new Date(trialInfo.end_time) - new Date(trialInfo.start_time)) / 1000).toFixed(2)} sec</td>
                                <td>${trialInfo.total_interactions}</td>
                            </tr>
                        </table>
                    `;
                    logViewer.innerHTML += trialSummary;

                    // Add trial entry details
                    if (trialInfo.trial_entries && trialInfo.trial_entries.length > 0) {
                        const trialValuesTable = `
                            <table>
                                <tr>
                                    <th>Entry</th><th>Interaction Time</th><th>Type</th>
                                    <th>Reward</th><th>Interactions Between</th><th>Time Between</th>
                                </tr>
                                ${trialInfo.trial_entries.map(entry => `
                                    <tr>
                                        <td>${entry.entry_num}</td>
                                        <td>${entry.rel_time.toFixed(2)}</td>
                                        <td>${entry.type}</td>
                                        <td>${entry.reward ? 'Yes' : 'No'}</td>
                                        <td>${entry.interactions_between}</td>
                                        <td>${entry.time_between.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        `;
                        logViewer.innerHTML += trialValuesTable;
                    } else {
                        logViewer.innerHTML += '<p>No trial entries available.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching the log:', error);
                    document.getElementById('log-viewer').innerHTML = '<p>Error loading log content.</p>';
                });
        }

        function showRemoteLogs() {
            fetch('/pull_user_logs')
                .then(response => response.json())
                .then(data => {
                    console.log('Remote logs data:', data); // Debugging log
                    const remoteLogsContainer = document.getElementById('remote-logs');
                    remoteLogsContainer.innerHTML = ''; // Clear existing content

                    data.data.forEach(trial => {
                        const trialElement = document.createElement('a');
                        trialElement.textContent = new Date(trial.start_time).toLocaleString();
                        trialElement.onclick = () => viewRemoteLog(trial);
                        remoteLogsContainer.appendChild(trialElement);
                    });
                })
                .catch(error => {
                    console.error('Error fetching remote trials:', error);
                    document.getElementById('remote-logs').innerHTML = '<p>Error loading remote logs.</p>';
                });

            document.getElementById('local-logs').style.display = 'none';
            document.getElementById('local-log-btn').style.backgroundColor = 'transparent';
            document.getElementById('remote-logs').style.display = 'block';
            document.getElementById('remote-log-btn').style.backgroundColor = '#3700B3';
            
            document.getElementById('download-btn').style.display = 'none';
            document.getElementById('download-excel-btn').style.display = 'none';
            document.getElementById('push-cloud-btn').style.display = 'none';
        }

        function showLocalLogs() {
            fetch('/list_local_logs')
                .then(response => response.json())
                .then(data => {
                    const localLogsContainer = document.getElementById('local-logs');
                    localLogsContainer.innerHTML = ''; // Clear existing content

                    data.log_files.forEach(log_file => {
                        const logElement = document.createElement('a');
                        logElement.textContent = log_file;
                        logElement.href = "#"; // Prevent page reload

                        logElement.onclick = function () {
                            console.log(`Clicked log: ${log_file}`); // Debugging log
                            viewLocalLog(log_file);
                        };

                        localLogsContainer.appendChild(logElement);
                    });

                    console.log("Local logs loaded:", data.log_files); // Debugging log

                })
                .catch(error => {
                    console.error('Error fetching local logs:', error);
                    document.getElementById('local-logs').innerHTML = '<p>Error loading local logs.</p>';
                });

            document.getElementById('remote-logs').style.display = 'none';
            document.getElementById('remote-log-btn').style.backgroundColor = 'transparent';
            document.getElementById('local-logs').style.display = 'block';
            document.getElementById('local-log-btn').style.backgroundColor = '#3700B3';
            
            document.getElementById('download-btn').href = '';
            document.getElementById('download-btn').style.display = 'none';
            document.getElementById('download-excel-btn').href = '';
            document.getElementById('download-excel-btn').style.display = 'none';
            document.getElementById('push-cloud-btn').style.display = 'none';
        }

        function pushLogToCloud() {
            const pushButton = document.getElementById('push-cloud-btn');
            const fileUrl = document.getElementById('download-btn').href;
            
            if (!fileUrl || fileUrl === window.location.href) {
                alert("No log selected to push.");
                return;
            }

            const filename = decodeURIComponent(fileUrl.split('/').pop());
            console.log(`Pushing log to cloud: ${filename}`);

            // Fetch the log file contents before sending
            fetch(`/view-log/${encodeURIComponent(filename)}`)
                .then(response => response.blob())  // Get the file as a Blob
                .then(blob => {
                    const formData = new FormData();
                    formData.append("file", blob, filename);  // Attach the file blob

                    return fetch('/push_log', {
                        method: 'POST',
                        body: formData
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error pushing log: ${data.error}`);
                    } else {
                        showToast("Log successfully pushed to the cloud!", true);
                        pushButton.style.display = 'none';  // Hide button after successful push
                        showLocalLogs(); // Refresh local logs after deletion
                    }
                })
                .catch(error => {
                    console.error('Error pushing log:', error);
                    alert("Failed to push log.");
                });
        }

        function downloadFile(type) {
            const filename = document.getElementById('download-btn').getAttribute("data-filename");

            if (!filename) {
                alert("No log selected for download.");
                return;
            }

            let downloadUrl = "";
            if (type === 'raw') {
                downloadUrl = `/download-raw-log/${encodeURIComponent(filename)}`;
            } else if (type === 'excel') {
                downloadUrl = `/download-excel-log/${encodeURIComponent(filename)}`;
            }

            console.log(`Downloading file from: ${downloadUrl}`);

            // Trigger file download
            const link = document.createElement("a");
            link.href = downloadUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showToast(message, success = true) {
            const toast = document.createElement('div');
            toast.className = `toast ${success ? 'toast-success' : 'toast-error'}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

    </script>
{% endblock %}

{% block content %}
    <div id="container">
        <div id="log-list">
            <div class="Buttons">
                <a id="remote-log-btn" href="javascript:showRemoteLogs();" style="width: 25%; display: none;">Remote</a>
                <a id="local-log-btn" href="javascript:showLocalLogs();" style="width: 25%; display: none;">Local</a>
            </div>
            <div id="remote-logs" style="display: none;">
                <div class="loader">
                    <span class="loader-text">loading</span>
                    <span class="load"></span>
                </div>
            </div>
            <div id="local-logs" style="display: none;">
                {% for log_file in log_files %}
                    <a onclick="viewLocalLog('{{ log_file }}')">{{ log_file }}</a>
                {% endfor %}
            </div>
            
            <div id="LoginWarning" style="display: none;">
                <p style="color: #3700B3;">Remote Log Viewer is only available to logged-in users.</p>
            </div>
        </div>
        <div id="log-viewer" style="display: block;">
            <p>Log Viewer:</p>
        </div>
    </div>
    <div id="download-buttons" class="button-container" style="display: block;">
        <!-- 📄 Download Raw Log -->
        <button class="cssbuttons-io-button" id="download-btn" style="display: none;" onclick="downloadFile('raw')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path fill="none" d="M0 0h24v24H0z"></path>
                <path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM6 20V4h7v5h5v11H6z"></path>
            </svg>
            <span>Download Raw Log</span>
        </button>

        <!-- 📊 Download Excel Log -->
        <button class="cssbuttons-io-button" id="download-excel-btn" style="display: none;" onclick="downloadFile('excel')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path fill="none" d="M0 0h24v24H0z"></path>
                <path fill="currentColor" d="M4 4h16v16H4z" opacity=".3"></path>
                <path fill="currentColor" d="M4 4v16h16V4H4zm2 14V6h12v12H6zm6-5.5l-1.41-1.41-2.12 2.12-2.12-2.12L5.5 12.5l2.12 2.12-2.12 2.12L7.59 17l2.12-2.12L11.83 17l1.41-1.41-2.12-2.12 2.12-2.12z"></path>
            </svg>
            <span>Download Excel Log</span>
        </button>

        <!-- ☁️ Push Log to Cloud -->
        <button class="cssbuttons-io-button" id="push-cloud-btn" style="display: none" onclick="pushLogToCloud();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path fill="none" d="M0 0h24v24H0z"></path>
                <path fill="currentColor" d="M19.35 10.04A7.49 7.49 0 0012 4 7.5 7.5 0 004.65 10.04 5.998 5.998 0 000 16c0 3.31 2.69 6 6 6h12c3.31 0 6-2.69 6-6 0-2.53-1.56-4.75-3.65-5.96zM11 13v4h2v-4h3l-4-4-4 4h3z"></path>
            </svg>
            <span>Push Log</span>
        </button>
    </div>
    <div id="toast-container"></div>
{% endblock %}
