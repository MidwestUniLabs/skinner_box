{% extends "base.html" %}

{% block title %}Skinnerbox - Homepage{% endblock %}

{% block content %}
<div class="container" style="display: block; text-align: center;">
    <section class="get-started" style="display: block;">
        <h2>Get Started</h2>
        <p>To run a trial click here: </p>
        <form action="/trial" method="post">
            <input type="submit" value="Go To Trial">
        </form>
        <p>To view logs click here: </p>
        <form action="/log-viewer" method="get">
            <input type="submit" value="View Logs">
        </form>
        <p>To test the I/O of your skinner box click here: </p>
        <form action="/test_io" method="post">
            <input type="submit" value="Test I/O">
        </form>
    </section>

    <br><br><hr style="width: 50%;"><br>

    <div class="LoginLogout" style="display: block;">
        <button onclick="document.getElementById('id01').style.display='block'" style="width:auto;">Login</button>
        <button onclick="logoutUser()" style="width:auto;">Logout</button>
        <div id="id02" style="display:none;">
            <h3>Logged in as: {{ current_user }}</h3>
        </div>
        <div id="id03" style="display:none;">
            <h3 style="color: red;">Not logged in</h3>
        </div>
        <div class="Login">
            <div id="id01" class="modal">
                <form class="modal-content animate" onsubmit="loginUser(event)">
                    <div class="imgcontainer">
                        <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close Modal">&times;</span>
                    </div>
                    <div class="container">
                        <label for="uname"><b>Username</b></label>
                        <input type="text" placeholder="Enter Username" name="uname" required>
                        <label for="psw"><b>Password</b></label>
                        <input type="password" placeholder="Enter Password" name="psw" required>
                        <button type="submit">Login</button>
                    </div>
                    <div class="container">
                        <button type="button" onclick="document.getElementById('id01').style.display='none'" class="cancelbtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container"></div>

{% endblock %}

{% block scripts %}
<script>
    onload = function() {
        fetch('/current_user')
            .then(response => response.json())
            .then(data => {
                if (data.current_user) {
                    document.getElementById('id02').style.display = 'block';
                    document.getElementById('id02').innerHTML = `<h3>Logged in as: ${data.current_user}</h3>`;
                    document.getElementById('id03').style.display = 'none';
                } else {
                    document.getElementById('id02').style.display = 'none';
                    document.getElementById('id03').style.display = 'block';
                }
            })
            .catch(error => console.error('Error fetching current user:', error));
    };

    function showToast(message, success = true) {
        const toast = document.createElement('div');
        toast.className = `toast ${success ? 'toast-success' : 'toast-error'}`;
        toast.textContent = message;
        document.getElementById('toast-container').appendChild(toast);

        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    function loginUser(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = {
            email: formData.get('uname'),
            password: formData.get('psw')
        };

        fetch('/login_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.access_token) {
                document.getElementById('id01').style.display = 'none';
                showToast('Login successful!', true);
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('Login failed', false);
            }
        });
    }

    function logoutUser() {
        fetch('/logout_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showToast(data.message, true);
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('Logout failed.', false);
            }
        })
        .catch(error => {
            console.error('Error logging out:', error);
            showToast('Logout failed due to an error.', false);
        });
    }
</script>
{% endblock %}
